<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DekDataset - AI Dataset Generator</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Add Google Fonts for better typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
    <!-- Add Bootstrap CSS for proper modal and component styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Add meta tags for better SEO and appearance -->
    <meta name="description" content="DekDataset - Advanced Thai AI/ML Dataset Generator powered by DeepSeek API and Ollama Local Models">
    <meta name="keywords" content="AI, Machine Learning, Dataset, Thai Language, DeepSeek, Ollama">
    <meta name="author" content="ZOMBIT - JonusNattapong">
    <style>        .pdf-drop-zone {
            border: 2px dashed #888;
            border-radius: 8px;
            padding: 2rem 1rem;
            text-align: center;
            color: #888;
            background: #fafbfc;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
            margin-bottom: 1rem;
        }
        .pdf-drop-zone.dragover {
            border-color: #007bff;
            background: #e6f0ff;
            color: #007bff;
        }
        
        /* Model Provider Styles */
        .model-provider-tabs {
            margin-bottom: 1rem;
        }
        
        .model-section {
            transition: all 0.3s ease;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .model-section.active {
            background: #fff;
            border-color: #007bff;
            box-shadow: 0 2px 4px rgba(0,123,255,0.1);
        }
        
        .loading-spinner {
            color: #6c757d;
            font-size: 0.9em;
        }

        /* Task item styles */
        .task-item {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .task-item:hover {
            background-color: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .task-item.selected {
            background-color: #e3f2fd;
            border-color: #2196f3;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
        }

        /* Alert container */
        #alertContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        }
    </style>
</head>
<body>
    <!-- Animated background elements -->
    <div class="bg-animation"></div>
    <div class="floating-elements">
        <div class="floating-element"></div>
        <div class="floating-element"></div>
        <div class="floating-element"></div>
    </div>

    <nav class="navbar">
        <div class="container">
            <a href="#" class="navbar-brand">
                <i class="fas fa-brain"></i>
                DekDataset
                <span style="font-size: 0.7rem; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-left: 0.5rem;">by ZOMBIT</span>
            </a>
        </div>
    </nav>

    <div class="container">
        <!-- Add alert container for notifications with enhanced styling -->
        <div id="alertContainer" style="position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;"></div>

        <div class="main-content">
            <!-- Task Management Panel with enhanced header -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-tasks"></i>
                    <h2>Task Management</h2>
                    <span class="badge bg-primary ms-auto" id="taskCount">0 tasks</span>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-list me-2"></i>Select Task
                    </label>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <select class="form-select" id="taskDropdown" style="flex: 1;">
                            <option value="">-- Select Task --</option>
                            <!-- Task options will be populated by JavaScript -->
                        </select>
                        <button class="btn btn-success" id="createTaskBtn" data-bs-toggle="modal" data-bs-target="#createTaskModal">
                            <i class="fas fa-plus"></i> Create
                        </button>
                        <button class="btn btn-secondary" id="refreshTasks">
                            <i class="fas fa-sync"></i>
                        </button>
                    </div>
                </div>

                <!-- Task Configuration Section moved below task list for better UX -->
                
                <div id="taskList">
                    <!-- Task items will be populated by JavaScript -->
                </div>
                <!-- Removed inline Task Configuration Section: now handled by popup modal -->
            </div>

            <!-- Generation Panel with enhanced styling -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-magic"></i>
                    <h2>Dataset Generation</h2>
                    <div class="status-indicator status-active ms-auto" title="System Ready"></div>
                </div>
                
                <div class="generation-panel">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-target me-2"></i>Selected Task
                        </label>
                        <input type="text" class="form-control" id="selectedTask" readonly placeholder="No task selected" style="background: rgba(102, 126, 234, 0.05);">
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-hashtag me-2"></i>Number of Entries
                        </label>
                        <input type="number" class="form-control" id="entryCount" value="10" min="1" max="1000">
                    </div>
                    
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label class="form-label">
                            <i class="fas fa-robot me-2"></i>Model Provider
                            <span id="modelLoadingIndicator" class="loading-spinner ms-2" style="display:none;">
                                <i class="fas fa-spinner fa-spin"></i> Loading models...
                            </span>
                        </label>
                        
                        <!-- Model Provider Selection with enhanced styling -->
                        <div class="model-provider-tabs mb-3">
                            <div class="btn-group w-100" role="group" aria-label="Model Provider">
                                <input type="radio" class="btn-check" name="modelProvider" id="deepseekProvider" value="deepseek" checked>
                                <label class="btn btn-outline-primary" for="deepseekProvider">
                                    <i class="fas fa-cloud me-2"></i> DeepSeek API
                                </label>
                                
                                <input type="radio" class="btn-check" name="modelProvider" id="ollamaProvider" value="ollama">
                                <label class="btn btn-outline-success" for="ollamaProvider">
                                    <i class="fas fa-home me-2"></i> Ollama Local
                                </label>
                            </div>
                        </div>

                        <!-- DeepSeek Models -->
                        <div id="deepseekModelSection" class="model-section active">
                            <label class="form-label small text-muted">
                                <i class="fas fa-cloud me-1"></i> DeepSeek Cloud Models
                            </label>
                            <select class="form-select" id="deepseekModelSelect">
                                <option value="">Loading DeepSeek models...</option>
                            </select>
                        </div>

                        <!-- Ollama Models -->
                        <div id="ollamaModelSection" class="model-section" style="display: none;">
                            <label class="form-label small text-muted">
                                <i class="fas fa-home me-1"></i> Ollama Local Models
                            </label>
                            <select class="form-select" id="ollamaModelSelect">
                                <option value="">Loading Ollama models...</option>
                            </select>
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle me-1"></i>Make sure Ollama is running locally on port 11434
                            </small>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <div class="btn-group">
                        <button class="btn btn-warning" id="testGeneration" disabled>
                            <i class="fas fa-flask"></i> Test Generation
                        </button>
                        <button class="btn btn-primary" id="generateDataset" disabled>
                            <i class="fas fa-rocket"></i> Generate Dataset
                        </button>
                        <!-- Add stop button -->
                        <button class="btn btn-danger" id="stopGeneration" style="display: none;">
                            <i class="fas fa-stop"></i> Stop Generation
                        </button>
                        <button class="btn btn-secondary" id="qualityBtn" data-bs-toggle="modal" data-bs-target="#qualityModal">
                            <i class="fas fa-shield-alt"></i> Quality Settings
                        </button>
                        <button class="btn btn-info" id="apiConfigBtn" data-bs-toggle="modal" data-bs-target="#apiConfigModal">
                            <i class="fas fa-key"></i> API Config
                        </button>
                    </div>
                </div>

                <!-- Enhanced Progress Section with stop functionality -->
                <div id="progressSection" style="display: none;">
                    <div class="progress mb-3">
                        <div class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div id="progressText" class="text-center text-muted">
                        <i class="fas fa-cog fa-spin me-2"></i>Initializing...
                    </div>
                    <div class="text-center mt-2">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            You can stop the generation at any time using the Stop button above
                        </small>
                    </div>
                </div>

                <!-- Results and Download Section -->
                <div id="downloadSection" style="display: none;">
                    <div id="resultSummary" class="mb-4">
                        <!-- Results will be displayed here -->
                    </div>

                    <!-- Preview Table Container -->
                    <div id="previewTableContainer">
                        <!-- Table will be inserted here by JavaScript -->
                    </div>

                    <!-- Sample Display (kept for JSON view) -->
                    <div id="sampleDisplay" class="mt-3">
                        <!-- Sample entry will be displayed here -->
                    </div>

                    <!-- Download Buttons -->
                    <div class="download-buttons mt-4">
                        <h5><i class="fas fa-download"></i> Download Dataset</h5>
                        <div class="btn-group">
                            <button class="btn btn-success download-btn" data-format="json" disabled>
                                <i class="fas fa-file-code"></i> Download JSONL
                            </button>
                            <button class="btn btn-info download-btn" data-format="csv" disabled>
                                <i class="fas fa-file-csv"></i> Download CSV
                            </button>
                            <button class="btn btn-warning download-btn" data-format="zip" disabled>
                                <i class="fas fa-file-archive"></i> Download ZIP
                            </button>
                        </div>
                        <p class="text-muted mt-2">
                            <i class="fas fa-info-circle"></i> 
                            JSONL format is recommended for machine learning tasks. CSV is good for analysis in Excel/Google Sheets.
                        </p>
                    </div>
                </div>

                <!-- PDF Upload Panel -->
                <div class="card" id="pdfUploadCard" style="margin-top:2rem;">
                    <div class="card-header" style="background:#f8f9fa;border-bottom:1px solid #eee;display:flex;align-items:center;gap:0.5rem;">
                        <i class="fas fa-file-pdf" style="color:#e74c3c;"></i>
                        <span style="font-weight:600;">Import Dataset from PDF (Mistral Document AI)</span>
                    </div>
                    <div class="pdf-upload-panel" style="padding:1.5rem 1rem 1rem 1rem;">
                        <div id="pdfDropZone" class="pdf-drop-zone" style="margin-bottom:1rem;">
                            <span id="pdfDropText"><i class="fas fa-upload"></i> Drag & drop PDF file here or click to select</span>
                            <input type="file" id="pdfFileInput" accept="application/pdf" style="display:none;" />
                        </div>
                        <div class="form-group" style="margin-bottom:0.5rem;">
                            <label class="form-label" style="font-weight:500;">Mistral API Key</label>
                            <input type="password" class="form-control" id="mistralApiKey" placeholder="sk-..." style="max-width:350px;">
                        </div>
                        <div class="form-group" style="margin-bottom:0.5rem;">
                            <label class="form-label" style="font-weight:500;">Annotation Options</label>
                            <div style="display:flex;gap:1.5rem;align-items:center;flex-wrap:wrap;">
                                <label style="margin-bottom:0;"><input type="checkbox" id="bboxAnnotation"> BBox Annotation</label>
                                <label style="margin-bottom:0;"><input type="checkbox" id="docAnnotation"> Document Annotation</label>
                                <label style="margin-bottom:0;">Pages: <input type="text" id="ocrPages" style="width:80px;" placeholder="e.g. 1,2,3"></label>
                            </div>
                        </div>
                        <button class="btn btn-primary" id="uploadPdfBtn" style="margin-top:1rem;width:100%;font-weight:600;font-size:1.1em;">
                            <i class="fas fa-magic"></i> Upload PDF & OCR
                        </button>
                        <div id="pdfUploadStatus" style="margin-top:1rem;"></div>
                        <div id="pdfEntriesPreview" style="margin-top:1rem;"></div>
                    </div>
                </div>
                <!-- End PDF Upload Panel -->

                <!-- Results Section -->
                <div id="resultsSection" style="display: none;">
                    <h3 style="margin-bottom: 1rem;">Generated Dataset</h3>
                    <div id="qualityReport" class="alert alert-info" style="display: none;"></div>
                    <div id="datasetPreview" style="margin-bottom: 2rem;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Task Modal -->
    <div class="modal fade" id="createTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createTaskForm">
                        <div class="mb-3">
                            <label class="form-label">Task ID</label>
                            <input type="text" class="form-control" id="taskId" placeholder="Enter unique task ID" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Task Type</label>
                            <select class="form-select" id="taskType">
                                <option value="custom">Custom</option>
                                <option value="qa">Question-Answer</option>
                                <option value="classification">Classification</option>
                                <option value="generation">Text Generation</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="taskDescription" rows="3" placeholder="Describe what this task does..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">System Prompt</label>
                            <textarea class="form-control" id="systemPrompt" rows="3" placeholder="System prompt for the model..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">User Template</label>
                            <textarea class="form-control" id="userTemplate" rows="3" placeholder="User template with placeholders..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveTask">
                        <i class="fas fa-plus"></i> Create Task
                    </button>
                </div>
            </div>
        </div>
    </div>    <!-- Edit Task Modal (always visible, JSON only, no mode switch) -->
    <div class="modal fade" id="editTaskModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Task</h5>
                    <button type="button" class="btn-close" id="closeEditTask"></button>
                </div>
                <div class="modal-body">
                    <div id="editJsonlMode">
                        <div class="mb-3">
                            <label class="form-label">Task Configuration (JSON Format)</label>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">แก้ไขข้อมูล Task ได้โดยตรงในรูปแบบ JSON (object เดียว)</small>
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-secondary" id="formatJsonBtn">
                                        <i class="fas fa-code"></i> Format
                                    </button>
                                    <button type="button" class="btn btn-outline-info" id="validateJsonBtn">
                                        <i class="fas fa-check"></i> Validate
                                    </button>
                                    <button type="button" class="btn btn-outline-dark" id="copyJsonBtn">
                                        <i class="fas fa-copy"></i> Copy
                                    </button>
                                </div>
                            </div>
                            <textarea class="form-control font-monospace" id="editTaskJsonl" rows="20"
                                placeholder='{
    "id": "task_name",
    "type": "custom",
    "description": "Task description",
    "system_prompt": "System prompt for the model...",
    "user_template": "User template with placeholders...",
    "examples": []
}'
                                style="font-size: 14px; line-height: 1.5; background-color: #f8f9fa; border: 2px solid #dee2e6; border-radius: 6px; resize: vertical; width: 100%; font-family: ''Consolas', 'Monaco', 'Courier New', monospace'; padding: 12px;"></textarea>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>JSON Format:</strong> แก้ไขข้อมูล Task ได้โดยตรงในรูปแบบ JSON object<br>
                            <span>
                                - สามารถแก้ไข <b>id</b>, <b>type</b>, <b>description</b>, <b>system_prompt</b>, <b>user_template</b>, <b>examples</b> และ field อื่นๆ ได้<br>
                                - กด <b>Format</b> เพื่อจัดรูปแบบ, <b>Validate</b> เพื่อตรวจสอบ, <b>Copy</b> เพื่อคัดลอก JSON<br>
                                - <b>เมื่อกดปุ่ม "Update from JSON" จะบันทึกข้อมูลทั้งหมดที่แก้ไขในรูปแบบ JSON นี้</b>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelEditTask">Cancel</button>
                    <button type="button" class="btn btn-success" id="updateTaskJsonl">
                        <i class="fas fa-save"></i> Update from JSON
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quality Settings Modal -->
    <div class="modal fade" id="qualityModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Quality Control Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Enable Quality Filter</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enableQualityFilter" checked>
                            <label class="form-check-label" for="enableQualityFilter">
                                Enable quality filtering
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Minimum Response Length</label>
                        <input type="number" class="form-control" id="minResponseLength" value="10" min="1">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Maximum Response Length</label>
                        <input type="number" class="form-control" id="maxResponseLength" value="2000" min="10">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Similarity Threshold: <span id="thresholdValue">0.8</span></label>
                        <input type="range" class="form-range" id="similarityThreshold" min="0" max="1" step="0.1" value="0.8">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Enable Duplicate Detection</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enableDuplicateDetection" checked>
                            <label class="form-check-label" for="enableDuplicateDetection">
                                Detect and remove duplicates
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveQuality">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- API Configuration Modal -->
    <div class="modal fade" id="apiConfigModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">API Configuration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Note:</strong> You need a DeepSeek API key to generate real datasets. Get one from <a href="https://platform.deepseek.com" target="_blank">platform.deepseek.com</a>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">DeepSeek API Key</label>
                        <input type="password" class="form-control" id="apiKey" placeholder="sk-...">
                        <small class="form-text text-muted">This will be stored in your environment variables for this session.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">API Status</label>
                        <div id="apiStatus" class="alert alert-secondary">
                            <i class="fas fa-question-circle"></i>
                            Status unknown - Click "Test API" to check
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="testApiBtn">
                        <i class="fas fa-flask"></i> Test API
                    </button>
                    <button type="button" class="btn btn-success" id="saveApiKey">
                        <i class="fas fa-save"></i> Save & Set
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Bootstrap JS for modal functionality -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/app.js"></script>
    
    <!-- Add initialization script for task count -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Update task count badge when tasks are loaded
            const originalUpdateTaskList = window.datasetGenerator?.updateTaskList;
            if (originalUpdateTaskList) {
                window.datasetGenerator.updateTaskList = function(tasks) {
                    originalUpdateTaskList.call(this, tasks);
                    const taskCountBadge = document.getElementById('taskCount');
                    if (taskCountBadge) {
                        taskCountBadge.textContent = `${tasks.length} task${tasks.length !== 1 ? 's' : ''}`;
                    }
                };
            }
        });
    </script>

    <!-- Task Configuration Modal (moved inside <body> for Bootstrap compatibility) -->
    <div class="modal fade" id="taskConfigModal" tabindex="-1" aria-labelledby="taskConfigModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="taskConfigModalLabel">Task Configuration</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <textarea id="taskJsonArea" class="form-control json-editor" rows="12"></textarea>
              <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                <button class="btn btn-primary btn-sm" id="saveTaskJson">
                  <i class="fas fa-save"></i> Save
                </button>
                <button class="btn btn-secondary btn-sm" id="reloadTaskJson">
                  <i class="fas fa-sync"></i> Reload
                </button>
                <button class="btn btn-outline-danger btn-sm" id="cancelTaskJson" data-bs-dismiss="modal">
                  <i class="fas fa-times"></i> Cancel
                </button>
              </div>
              <div id="taskJsonMsg" style="margin-top: 0.5rem;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>    <!-- Custom Modal System Script -->
    <script>
    // Custom Modal System
    class CustomModal {
        constructor(element) {
            this.element = element;
            this.overlay = null;
            this.isVisible = false;
        }        show() {
            if (this.isVisible) return;
            
            // Create overlay
            this.overlay = document.createElement('div');
            this.overlay.className = 'custom-modal-overlay';
            
            // Create modal content wrapper
            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'custom-modal-content';
            
            // Determine modal size
            const dialogElem = this.element.querySelector('.modal-dialog');
            if (dialogElem) {
                if (dialogElem.classList.contains('modal-lg')) {
                    this.overlay.classList.add('custom-modal-lg');
                } else if (dialogElem.classList.contains('modal-xl')) {
                    this.overlay.classList.add('custom-modal-xl');
                } else if (dialogElem.classList.contains('modal-sm')) {
                    this.overlay.classList.add('custom-modal-sm');
                }
            }
            
            // Extract modal content
            const header = this.element.querySelector('.modal-header');
            const body = this.element.querySelector('.modal-body');
            const footer = this.element.querySelector('.modal-footer');
            
            // Create custom header
            if (header) {
                const customHeader = document.createElement('div');
                customHeader.className = 'custom-modal-header';
                
                const title = document.createElement('h5');
                title.className = 'custom-modal-title';
                const titleText = header.querySelector('.modal-title');
                title.innerHTML = titleText ? titleText.innerHTML : 'Modal';
                
                const closeBtn = document.createElement('button');
                closeBtn.className = 'custom-modal-close';
                closeBtn.innerHTML = '<i class="fas fa-times"></i>';
                closeBtn.onclick = () => this.hide();
                
                customHeader.appendChild(title);
                customHeader.appendChild(closeBtn);
                contentWrapper.appendChild(customHeader);
            }
            
            // Create custom body - clone the original body to preserve form elements
            if (body) {
                const customBody = document.createElement('div');
                customBody.className = 'custom-modal-body';
                
                // Clone the body element to preserve form data and event handlers
                const bodyClone = body.cloneNode(true);
                customBody.appendChild(bodyClone);
                contentWrapper.appendChild(customBody);
            }
            
            // Create custom footer
            if (footer) {
                const customFooter = document.createElement('div');
                customFooter.className = 'custom-modal-footer';
                
                // Clone footer to preserve button functionality
                const footerClone = footer.cloneNode(true);
                customFooter.appendChild(footerClone);
                
                // Update close buttons in footer
                customFooter.querySelectorAll('[data-bs-dismiss="modal"]').forEach(btn => {
                    btn.onclick = () => this.hide();
                    btn.removeAttribute('data-bs-dismiss');
                });
                
                // Re-bind event handlers for Update Task button
                const updateBtn = customFooter.querySelector('#updateTask');
                if (updateBtn && window.datasetGenerator) {
                    updateBtn.onclick = () => window.datasetGenerator.updateTask();
                }
                
                contentWrapper.appendChild(customFooter);
            }
            
            this.overlay.appendChild(contentWrapper);
            document.body.appendChild(this.overlay);
            
            // Show with animation
            requestAnimationFrame(() => {
                this.overlay.classList.add('show');
                // Rebind Edit Task Modal events if this is the edit modal
                if (this.element.id === 'editTaskModal' && window.datasetGenerator && typeof window.datasetGenerator.rebindEditTaskModalEvents === 'function') {
                    setTimeout(() => window.datasetGenerator.rebindEditTaskModalEvents(), 50);
                }
            });
            
            // Close on overlay click
            this.overlay.addEventListener('click', (e) => {
                if (e.target === this.overlay) {
                    this.hide();
                }
            });
            
            // Close on escape key
            document.addEventListener('keydown', this.escapeHandler);
            
            this.isVisible = true;
        }

        hide() {
            if (!this.isVisible || !this.overlay) return;
            
            this.overlay.classList.remove('show');
            
            setTimeout(() => {
                if (this.overlay && this.overlay.parentNode) {
                    this.overlay.parentNode.removeChild(this.overlay);
                }
                this.overlay = null;
            }, 300);
            
            document.removeEventListener('keydown', this.escapeHandler);
            this.isVisible = false;
        }

        escapeHandler = (e) => {
            if (e.key === 'Escape') {
                this.hide();
            }
        }
    }

    // Initialize custom modals when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing custom modal system...');
          // Find all modal triggers and set up custom handlers
        const modalTriggers = [
            { selector: 'button[data-bs-target="#createTaskModal"]', modalId: 'createTaskModal' },
            { selector: 'button[data-bs-target="#qualityModal"]', modalId: 'qualityModal' },
            { selector: 'button[data-bs-target="#apiConfigModal"]', modalId: 'apiConfigModal' },
            { selector: '.btn-outline-primary', modalId: 'taskConfigModal' } // Edit buttons
        ];
        
        modalTriggers.forEach(({ selector, modalId }) => {
            const buttons = document.querySelectorAll(selector);
            const modalElement = document.getElementById(modalId);
            
            if (modalElement) {
                const customModal = new CustomModal(modalElement);
                
                buttons.forEach(button => {
                    // Remove Bootstrap attributes
                    button.removeAttribute('data-bs-toggle');
                    button.removeAttribute('data-bs-target');
                    
                    // Add custom click handler
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log(`Opening modal: ${modalId}`);
                        customModal.show();
                    });
                });
                
                console.log(`Initialized custom modal: ${modalId}`);
            } else {
                console.error(`Modal element not found: ${modalId}`);
            }
        });          // Handle Edit buttons specifically (they are generated dynamically)
        // Note: Edit button handlers are now managed by the main DatasetGenerator class
        
        // Test function for debugging
        window.openModal = function(modalId) {
            const modalElement = document.getElementById(modalId);
            if (modalElement) {
                const customModal = new CustomModal(modalElement);
                customModal.show();
                console.log(`Manually opened modal: ${modalId}`);
            } else {
                console.error(`Modal not found: ${modalId}`);
            }
        };
        
        console.log('Custom modal system initialized successfully!');
        console.log('Available test function: openModal("modalId")');
        console.log('Available modals: createTaskModal, qualityModal, apiConfigModal, taskConfigModal');
    });
    </script>

    <script>
// Patch: Prevent JS error if form fields are not present (JSON-only modal)
(function() {
    // Override populateEditForm to only update the JSON textarea
    if (window.datasetGenerator) {
        window.datasetGenerator.populateEditForm = function(taskData) {
            // Only update the JSON textarea, do not touch form fields
            var jsonlTextarea = document.getElementById('editTaskJsonl');
            if (jsonlTextarea) {
                jsonlTextarea.value = JSON.stringify(taskData, null, 2);
            }
        };
        // Also patch syncFormToJsonl and syncJsonlToForm to no-op
        window.datasetGenerator.syncFormToJsonl = function() {};
        window.datasetGenerator.syncJsonlToForm = function() {};
    }
})();
    </script>
</body>
</html>